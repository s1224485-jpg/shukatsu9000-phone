<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>マザー・シューカーツ</title>
<style>
  body{
    margin:0; background:#000; color:#d8ff6a;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    min-height:100vh;
  }
  #wrap{ max-width: 560px; margin: 0 auto; padding: 16px; }
  #screen{
    border:1px solid #d8ff6a55; border-radius:16px; padding:16px;
    background: rgba(216,255,106,0.05);
  }
  .card{ display:flex; flex-direction:column; gap:12px; }
  .hidden{ display:none; }

  .title{ font-weight:900; font-size:18px; letter-spacing:.02em; }
  .box{
    border:1px solid rgba(216,255,106,0.45);
    background: rgba(216,255,106,0.08);
    border-radius:14px;
    padding:12px 12px;
    line-height:1.65;
  }
  label{ font-size:13px; opacity:.85; margin-top:6px; }
  input, textarea{
    width:100%; box-sizing:border-box;
    padding:12px; border-radius:12px;
    border:1px solid #d8ff6a33; background:#050505; color:#d8ff6a;
    font-size:16px;
  }
  textarea{ min-height:90px; resize: vertical; }

  .row{ display:flex; gap:10px; flex-wrap: wrap; }
  .btn{
    padding:12px 12px; border-radius:12px;
    border:1px solid rgba(216,255,106,0.35);
    background: rgba(216,255,106,0.12);
    color:#d8ff6a; font-size:16px; font-weight:800;
  }
  .btn.primary{ background:#d8ff6a; color:#000; border-color:#d8ff6a; }
  .btn.wide{ flex: 1 1 160px; }
  .tiny{ font-size:12px; opacity:.78; line-height:1.5; }

  #resultImg{ width:100%; border-radius:12px; border:1px solid #d8ff6a33; background:#111; }
  .credit{ line-height:1.75; opacity:.95; }

  a.linkbtn{ text-decoration:none; display:inline-block; }
</style>
</head>
<body>
<div id="wrap">
  <div id="screen">

    <!-- START -->
    <div id="screenStart" class="card">
      <div class="title">マザー・シューカーツ</div>
      <div class="box">
        ワタシは就活支援プログラムのマザー・シューカーツです。<br>
        一緒に理想的な自己PRシートを生成しまショウ♡
      </div>
      <button id="btnGoForm" class="btn primary">スタート</button>
    </div>

    <!-- FORM -->
    <div id="screenForm" class="card hidden">
      <div class="title">質問に回答してください</div>

      <label>お名前（任意）</label>
      <input id="name" placeholder="例：ゲスト" />

      <label>Q1：自己PRとして、あなたの強みを一言で</label>
      <textarea id="q1" placeholder="例：人を巻き込んで企画を動かす"></textarea>

      <label>Q2：あなたの弱みを一言で</label>
      <textarea id="q2" placeholder="例：忘れっぽい"></textarea>

      <label>Q3：これまでの一番の功績を一言で</label>
      <textarea id="q3" placeholder="例：文化祭の展示をまとめ上げた"></textarea>

      <div class="row">
        <button id="btnBackStart" class="btn wide">戻る</button>
        <button id="btnToCamera" class="btn primary wide">次へ</button>
      </div>
    </div>

    <!-- CAMERA / UPLOAD -->
    <div id="screenCamera" class="card hidden">
      <div class="title">写真を選んで加工シマス♡</div>

      <div class="box tiny">
        スマホのアルバムから写真を選んでください。<br>
        顔写真じゃなくてもOK♡
      </div>

      <input id="photoInput" type="file" accept="image/*" />

      <div style="position:relative; width:100%; aspect-ratio: 3/4; background:#111; border-radius:12px; overflow:hidden; border:1px solid #d8ff6a33;">
        <img id="photoPreview" alt="プレビュー" style="width:100%; height:100%; object-fit:cover;">
        <div style="position:absolute; inset:10%; border:2px dashed rgba(216,255,106,0.5); border-radius:12px; pointer-events:none;"></div>
        <div id="flash" style="position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;"></div>
      </div>

      <div class="row">
        <button id="btnCamBack" class="btn wide">戻る</button>
        <button id="btnProcessPhoto" class="btn primary wide">次へ</button>
      </div>

      <div class="tiny">※画像を選んでから「次へ」を押してください。</div>

      <canvas id="shotCanvas" width="512" height="512" class="hidden"></canvas>
    </div>

    <!-- RESULT -->

    <div id="screenResult" class="card hidden">
      <div class="title">生成完了</div>
<img id="resultImg" alt="自己PRシート画像" />

      <div class="row">
        <button id="btnRetry" class="btn wide">やり直し</button>
        <button id="btnSave" class="btn primary wide">保存</button>
      </div>
      <div class="row">
        <button id="btnOpen" class="btn wide">画像を別タブで開く</button>
        <button id="btnClose" class="btn wide">とじる</button>
      </div>

      <div class="tiny">保存できない場合：画像を長押し→保存 / スクショでもOK</div>
    </div>

    <!-- END / CREDIT -->
    <div id="screenCredit" class="card hidden">
      <div class="title">完了</div>

      <div class="box">
        お疲れ様でしタ！これで明るい未来が待ってまス♡
      </div>

      <div class="row">
        <a class="linkbtn btn wide" href="./about.html">この作品についての解説</a>
        <button id="btnRestart" class="btn primary wide">最初に戻る</button>
      </div>

      <div class="tiny" style="margin-top:2px;">
        ※当プログラムは一切の責任を負いませんのでご注意ください。
      </div>

      <div class="credit">
        第74回 東京藝術大学 卒業・修了作品展<br>
        「マザー・シューカーツ」<br>
        東京藝術大学大学院 美術研究科 先端芸術表現専攻<br>
        マッキン愛奈
      </div>
    </div>

  </div>
</div>

<!-- 履歴書生成用（非表示） -->
<canvas id="displaySheetCanvas" width="1240" height="1754" style="display:none;"></canvas></canvas>

<script>
const session = {
  name: "ゲスト",
  qa: [],
  photoDataUrl: null,
  displaySheetDataUrl: null,
};

// hidden canvas for sheet rendering
const displaySheetCanvas = document.getElementById("displaySheetCanvas");
const displaySheetCtx = displaySheetCanvas.getContext("2d", { willReadFrequently: true });


// ---------- screen ----------
const screens = ["screenStart","screenForm","screenCamera","screenResult","screenCredit"];
function show(id){
  for(const s of screens) document.getElementById(s).classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
  window.scrollTo({top:0, behavior:"instant"});
}

// ---------- “最強化”テキスト（軽量版） ----------
function motherRewrite(raw, severity){
    const s = (raw || "").trim();
    if(!s){
      return severity < 0.6 ? "沈黙は、熟考として整理します。" : "沈黙は、余裕として確定します。";
    }

    let out = s
      .replace(/暗い|陰キャ|人見知り/g, "落ち着いて状況を観察できる")
      .replace(/時間にルーズ|遅刻|寝坊/g, "柔軟に動きつつ締切を守れる")
      .replace(/弱み|苦手|下手/g, "伸びしろが大きい")
      .replace(/できない|無理|むずかしい/g, "伸びしろがある")
      .replace(/疲れた|しんどい|つらい/g, "負荷の中でも成果を出せる");

    const inject = ["主体性","再現性","巻き込み力","高速PDCA","数値で語る","即戦力","期限厳守","顧客起点","オーナーシップ","柔軟性","同調力","自動修正"];
    const n = Math.min(10, 3 + Math.floor(severity * 10));
    const chosen = inject.slice(0, n).join("・");

    if(severity < 0.35) out = `補正：${out}（${chosen}）`;
    else if(severity < 0.7) out = `強制補正：${out}。${chosen}を標準搭載します。`;
    else out = `最終補正：${chosen}を常時実行します。原文：${out}`;

    return out.slice(0, 360);
  }


// ---------- download ----------
function downloadImage(){
  if(!session.displaySheetDataUrl) return;
  const a = document.createElement("a");
  a.download = "shukatsu9000_resume.png";
  a.href = session.displaySheetDataUrl;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// ---------- photo (upload) ----------
const photoInput = document.getElementById("photoInput");
const photoPreview = document.getElementById("photoPreview");
const shotCanvas = document.getElementById("shotCanvas");
const shotCtx = shotCanvas.getContext("2d", { willReadFrequently: true });

function flashOnce(){
  const f = document.getElementById("flash");
  f.style.opacity = "1";
  setTimeout(()=> f.style.opacity = "0", 120);
}

function coverDrawImageToCanvas(img, canvas, ctx){
  const W = canvas.width, H = canvas.height;
  const ar = img.width / img.height;
  const br = W / H;
  let sx=0, sy=0, sw=img.width, sh=img.height;
  if(ar > br){
    sh = img.height;
    sw = sh * br;
    sx = (img.width - sw)/2;
  }else{
    sw = img.width;
    sh = sw / br;
    sy = (img.height - sh)/2;
  }
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(img, sx, sy, sw, sh, 0,0,W,H);
}

function glitchRGBShift(ctx, w, h, maxShift){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  const out = new Uint8ClampedArray(d.length);

  const shiftR = Math.floor((Math.random()*2-1) * maxShift);
  const shiftG = Math.floor((Math.random()*2-1) * (maxShift*0.6));
  const shiftB = Math.floor((Math.random()*2-1) * (maxShift*0.8));

  function idx(x,y){ return (y*w + x)*4; }
  function clampX(x){ return Math.max(0, Math.min(w-1, x)); }

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const i = idx(x,y);
      const rI = idx(clampX(x+shiftR), y);
      const gI = idx(clampX(x+shiftG), y);
      const bI = idx(clampX(x+shiftB), y);
      out[i]   = d[rI];
      out[i+1] = d[gI+1];
      out[i+2] = d[bI+2];
      out[i+3] = 255;
    }
  }
  img.data.set(out);
  ctx.putImageData(img,0,0);
}

function glitchScanlines(ctx, w, h){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  for(let y=0;y<h;y++){
    const dark = (y % 3 === 0);
    for(let x=0;x<w;x++){
      const i = (y*w + x)*4;
      if(dark){
        d[i]   = d[i]   * 0.88;
        d[i+1] = d[i+1] * 0.88;
        d[i+2] = d[i+2] * 0.88;
      }
    }
  }
  ctx.putImageData(img,0,0);
}

function glitchSliceShift(ctx, w, h){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  const out = new Uint8ClampedArray(d.length);
  out.set(d);

  const slices = 10;
  for(let s=0;s<slices;s++){
    const y0 = Math.floor(Math.random()*h);
    const sh = Math.floor(10 + Math.random()*30);
    const dx = Math.floor((Math.random()*2-1) * 35);
    for(let y=y0; y<Math.min(h, y0+sh); y++){
      for(let x=0;x<w;x++){
        const sx = Math.max(0, Math.min(w-1, x+dx));
        const i = (y*w + x)*4;
        const j = (y*w + sx)*4;
        out[i] = d[j];
        out[i+1] = d[j+1];
        out[i+2] = d[j+2];
        out[i+3] = 255;
      }
    }
  }
  img.data.set(out);
  ctx.putImageData(img,0,0);
}

function glitchNoise(ctx, w, h, amount=0.06){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  const a = Math.max(0, Math.min(0.25, amount));
  for(let i=0;i<d.length;i+=4){
    const n = (Math.random()*2-1) * 255 * a;
    d[i]   = Math.max(0, Math.min(255, d[i] + n));
    d[i+1] = Math.max(0, Math.min(255, d[i+1] + n));
    d[i+2] = Math.max(0, Math.min(255, d[i+2] + n));
  }
  ctx.putImageData(img,0,0);
}

function applyGlitch(){
  const w = shotCanvas.width, h = shotCanvas.height;
  glitchSliceShift(shotCtx, w, h);
  glitchRGBShift(shotCtx, w, h, 10);
  glitchScanlines(shotCtx, w, h);
  glitchNoise(shotCtx, w, h, 0.05);
}

let loadedImage = null;

photoInput.addEventListener("change", async () => {
  const file = photoInput.files && photoInput.files[0];
  if(!file) return;

  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => {
    loadedImage = img;
    photoPreview.src = url;
  };
  img.onerror = () => {
    loadedImage = null;
    photoPreview.removeAttribute("src");
    URL.revokeObjectURL(url);
    alert("画像の読み込みに失敗しました");
  };
  img.src = url;
});

async function processUploadedPhoto(){
  if(!loadedImage) return false;
  shotCanvas.width = 512; shotCanvas.height = 512;
  coverDrawImageToCanvas(loadedImage, shotCanvas, shotCtx);
  applyGlitch();
  session.photoDataUrl = shotCanvas.toDataURL("image/png");
  return true;
}


async function safeGenerateDisplaySheet(){
  try{
    await generateDisplayOnly();
  }catch(e){
    console.error("generateDisplayOnly failed:", e);
    // 失敗しても、描けている範囲で画像化して進行（展示優先）
    try{
      session.displaySheetDataUrl = displaySheetCanvas.toDataURL("image/png");
    }catch(_){}
  }
}

// ---------- wiring ----------

const nameEl = document.getElementById("name");
const q1El = document.getElementById("q1");
const q2El = document.getElementById("q2");
const q3El = document.getElementById("q3");
const resultImg = document.getElementById("resultImg");

document.getElementById("btnGoForm").onclick = () => show("screenForm");
document.getElementById("btnBackStart").onclick = () => show("screenStart");

document.getElementById("btnToCamera").onclick = async () => {
  session.name = (nameEl.value || "").trim() || "ゲスト";
  const a1 = (q1El.value || "").trim();
  const a2 = (q2El.value || "").trim();
  const a3 = (q3El.value || "").trim();

  const questions = ['第一問です。自己PRとして、あなたの強みを一言で教えてください。', '第二問です。あなたの弱みを一言で教えてください。正直にどうぞ♡', '第三問です。これまでの一番の功績を一言で教えてください。'];
  const raws = [a1 || "（沈黙）", a2 || "（沈黙）", a3 || "（沈黙）"];

  session.qa = raws.map((raw, i) => {
    const severity = i / 2; // 0, 0.5, 1.0
    return {
      q: questions[i],
      raw,
      rewritten: motherRewrite(raw, severity),
      severity
    };
  });

  show("screenCamera");
};

document.getElementById("btnCamBack").onclick = () => {
    show("screenForm");
};

document.getElementById("btnProcessPhoto").onclick = async () => {
  const btn = document.getElementById("btnProcessPhoto");
  btn.disabled = true;
  const original = btn.textContent;
  btn.textContent = "処理中…";
  try{
    const ok = await processUploadedPhoto();
    flashOnce();
    if(!ok){
      alert("先に画像を選んでください");
      return;
    }

    await safeGenerateDisplaySheet();

    const imgEl = document.getElementById("resultImg");
    imgEl.src = session.displaySheetDataUrl || displaySheetCanvas.toDataURL("image/png");
    show("screenResult");
  }finally{
    btn.disabled = false;
    btn.textContent = original;
  }
};


document.getElementById("btnRetry").onclick = () => show("screenForm");
document.getElementById("btnSave").onclick = () => downloadImage();

document.getElementById("btnOpen").onclick = () => {
  if(!session.displaySheetDataUrl) return;
  const w = window.open();
  if(!w) return;
  w.document.write(`<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><img src="${session.displaySheetDataUrl}" style="width:100%;height:auto;">`);
};

document.getElementById("btnClose").onclick = () => show("screenCredit");

document.getElementById("btnRestart").onclick = () => {
    [nameEl,q1El,q2El,q3El].forEach(el=>el.value="");
  session.photoDataUrl = null;
  session.displaySheetDataUrl = null;
  show("screenStart");
};

show("screenStart");
</script>
</body>
</html>


function addNoise(ctx, w, h, strength=0.10){
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){
      const n = (Math.random()-0.5)*255*strength;
      d[i]   = Math.max(0, Math.min(255, d[i] + n));
      d[i+1] = Math.max(0, Math.min(255, d[i+1] + n));
      d[i+2] = Math.max(0, Math.min(255, d[i+2] + n));
    }
    ctx.putImageData(img,0,0);
  }

function drawSheetFrameDisplay(ctx, W, H){
    ctx.save();
    ctx.fillStyle = "#070707";
    ctx.fillRect(0,0,W,H);

    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgba(216,255,106,0.10)");
    g.addColorStop(1, "rgba(216,255,106,0.02)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle = "rgba(216,255,106,0.75)";
    ctx.lineWidth = 6;
    ctx.strokeRect(32,32,W-64,H-64);

    ctx.strokeStyle = "rgba(216,255,106,0.25)";
    ctx.lineWidth = 2;
    ctx.strokeRect(54,54,W-108,H-108);

    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.lineWidth = 1;
    for(let y=60; y<H-60; y+=6){
      ctx.beginPath(); ctx.moveTo(54,y); ctx.lineTo(W-54,y); ctx.stroke();
    }
    ctx.restore();
  }

function drawJPBlock(ctx, text, x, y, maxWidth, lineHeight, font, color, maxLines=999){
    ctx.save();
    ctx.font = font;
    ctx.fillStyle = color;
    ctx.textBaseline = "top";

    let line = "";
    let lines = 0;
    for(const ch of text){
      if(ch === "\n"){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = "";
        continue;
      }
      const test = line + ch;
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = ch;
      } else {
        line = test;
      }
    }
    if(line && lines < maxLines){
      ctx.fillText(line, x, y + lines*lineHeight);
    }
    ctx.restore();
  }

const SHEET_TITLE = "マザー・シューカーツによる就活アドバイスシート";
async function drawDisplaySheet(){
    const ctx = displaySheetCtx;
    const W = displaySheetCanvas.width;
    const H = displaySheetCanvas.height;

    drawSheetFrameDisplay(ctx, W, H);

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 44px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText("SHUKATSU 9000", 70, 86);

    ctx.font = "bold 28px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.75)";
    ctx.fillText("MOTHER SHUKATSU", 70, 142);

    ctx.font = "14px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.55)";
    ctx.fillText("※ 本書類はマザー・シューカーツにより生成されています。自己同一性の保証はありません。", 70, 178);
    ctx.restore();

    const photoX = W - 70 - 330;
    const photoY = 240;
    const photoW = 330;
    const photoH = 440;

    ctx.save();
    ctx.strokeStyle = "rgba(216,255,106,0.85)";
    ctx.lineWidth = 5;
    ctx.strokeRect(photoX, photoY, photoW, photoH);
    ctx.restore();

    if(session.photoDataUrl){
      const img = new Image();
      await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; img.src = session.photoDataUrl; });
      ctx.drawImage(img, photoX+4, photoY+4, photoW-8, photoH-8);
    }

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 30px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText(SHEET_TITLE, 70, 240);

    ctx.font = "bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.85)";
    ctx.fillText("氏名", 70, 288);

    ctx.font = "bold 48px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.fillText(session.name, 70, 330);
    ctx.restore();

    const qaX=70, qaY=420, qaW=W-140, qaH=1130;
    ctx.save();
    ctx.strokeStyle="rgba(216,255,106,0.35)";
    ctx.lineWidth=2;
    ctx.strokeRect(qaX,qaY,qaW,qaH);
    ctx.font="bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle="rgba(216,255,106,0.92)";
    ctx.fillText("会話ログ（矯正強度つき）", qaX+10, qaY+10);
    ctx.restore();

    let qaText = session.qa.map((x,i)=>(
      `Q${i+1} 矯正${Math.round(x.severity*100)}% ${x.q}\n`+
      `YOU: ${x.raw}\n`+
      `MOTHER: ${x.rewritten}\n`+
      `判定: S+`
    )).join("\n\n");

    const auditChunk =
      "\n\n[監査ログ] 整合性を再計算。OK。" +
      "\n[監査ログ] 表情補正の係数を再推定。OK。" +
      "\n[監査ログ] 企業別の理想像へ再マッピング。OK。";
    while(qaText.length < 3200) qaText += auditChunk;
    qaText = qaText.slice(0, 5200);

    drawJPBlock(ctx, qaText, qaX+10, qaY+44, qaW-20, 22,
      "16px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'",
      "rgba(216,255,106,0.70)",
      44);

    ctx.save();
    ctx.fillStyle="rgba(216,255,106,0.55)";
    ctx.font="14px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'";
    ctx.fillText(`MOTHER SHUKATSU // ${new Date().toLocaleString("ja-JP")}`, 70, H-60);
    ctx.restore();
  }function drawJPBlock(ctx, text, x, y, maxWidth, lineHeight, font, color, maxLines=999){
    ctx.save();
    ctx.font = font;
    ctx.fillStyle = color;
    ctx.textBaseline = "top";

    let line = "";
    let lines = 0;
    for(const ch of text){
      if(ch === "\n"){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = "";
        continue;
      }
      const test = line + ch;
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = ch;
      } else {
        line = test;
      }
    }
    if(line && lines < maxLines){
      ctx.fillText(line, x, y + lines*lineHeight);
    }
    ctx.restore();
  }

async function drawDisplaySheet(){
    const ctx = displaySheetCtx;
    const W = displaySheetCanvas.width;
    const H = displaySheetCanvas.height;

    drawSheetFrameDisplay(ctx, W, H);

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 44px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText("SHUKATSU 9000", 70, 86);

    ctx.font = "bold 28px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.75)";
    ctx.fillText("MOTHER SHUKATSU", 70, 142);

    ctx.font = "14px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.55)";
    ctx.fillText("※ 本書類はマザー・シューカーツにより生成されています。自己同一性の保証はありません。", 70, 178);
    ctx.restore();

    const photoX = W - 70 - 330;
    const photoY = 240;
    const photoW = 330;
    const photoH = 440;

    ctx.save();
    ctx.strokeStyle = "rgba(216,255,106,0.85)";
    ctx.lineWidth = 5;
    ctx.strokeRect(photoX, photoY, photoW, photoH);
    ctx.restore();

    if(session.photoDataUrl){
      const img = new Image();
      await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; img.src = session.photoDataUrl; });
      ctx.drawImage(img, photoX+4, photoY+4, photoW-8, photoH-8);
    }

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 30px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText(SHEET_TITLE, 70, 240);

    ctx.font = "bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.85)";
    ctx.fillText("氏名", 70, 288);

    ctx.font = "bold 48px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.fillText(session.name, 70, 330);
    ctx.restore();

    const qaX=70, qaY=420, qaW=W-140, qaH=1130;
    ctx.save();
    ctx.strokeStyle="rgba(216,255,106,0.35)";
    ctx.lineWidth=2;
    ctx.strokeRect(qaX,qaY,qaW,qaH);
    ctx.font="bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle="rgba(216,255,106,0.92)";
    ctx.fillText("会話ログ（矯正強度つき）", qaX+10, qaY+10);
    ctx.restore();

    let qaText = session.qa.map((x,i)=>(
      `Q${i+1} 矯正${Math.round(x.severity*100)}% ${x.q}\n`+
      `YOU: ${x.raw}\n`+
      `MOTHER: ${x.rewritten}\n`+
      `判定: S+`
    )).join("\n\n");

    const auditChunk =
      "\n\n[監査ログ] 整合性を再計算。OK。" +
      "\n[監査ログ] 表情補正の係数を再推定。OK。" +
      "\n[監査ログ] 企業別の理想像へ再マッピング。OK。";
    while(qaText.length < 3200) qaText += auditChunk;
    qaText = qaText.slice(0, 5200);

    drawJPBlock(ctx, qaText, qaX+10, qaY+44, qaW-20, 22,
      "16px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'",
      "rgba(216,255,106,0.70)",
      44);

    ctx.save();
    ctx.fillStyle="rgba(216,255,106,0.55)";
    ctx.font="14px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'";
    ctx.fillText(`MOTHER SHUKATSU // ${new Date().toLocaleString("ja-JP")}`, 70, H-60);
    ctx.restore();
  }

function addNoise(ctx, w, h, strength=0.10){
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){
      const n = (Math.random()-0.5)*255*strength;
      d[i]   = Math.max(0, Math.min(255, d[i] + n));
      d[i+1] = Math.max(0, Math.min(255, d[i+1] + n));
      d[i+2] = Math.max(0, Math.min(255, d[i+2] + n));
    }
    ctx.putImageData(img,0,0);
  }

function drawSheetFrameDisplay(ctx, W, H){
    ctx.save();
    ctx.fillStyle = "#070707";
    ctx.fillRect(0,0,W,H);

    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgba(216,255,106,0.10)");
    g.addColorStop(1, "rgba(216,255,106,0.02)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle = "rgba(216,255,106,0.75)";
    ctx.lineWidth = 6;
    ctx.strokeRect(32,32,W-64,H-64);

    ctx.strokeStyle = "rgba(216,255,106,0.25)";
    ctx.lineWidth = 2;
    ctx.strokeRect(54,54,W-108,H-108);

    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.lineWidth = 1;
    for(let y=60; y<H-60; y+=6){
      ctx.beginPath(); ctx.moveTo(54,y); ctx.lineTo(W-54,y); ctx.stroke();
    }
    ctx.restore();
  }

function addNoise(ctx, w, h, strength=0.10){
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){
      const n = (Math.random()-0.5)*255*strength;
      d[i]   = Math.max(0, Math.min(255, d[i] + n));
      d[i+1] = Math.max(0, Math.min(255, d[i+1] + n));
      d[i+2] = Math.max(0, Math.min(255, d[i+2] + n));
    }
    ctx.putImageData(img,0,0);
  }

function drawSheetFrameDisplay(ctx, W, H){
    ctx.save();
    ctx.fillStyle = "#070707";
    ctx.fillRect(0,0,W,H);

    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "rgba(216,255,106,0.10)");
    g.addColorStop(1, "rgba(216,255,106,0.02)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle = "rgba(216,255,106,0.75)";
    ctx.lineWidth = 6;
    ctx.strokeRect(32,32,W-64,H-64);

    ctx.strokeStyle = "rgba(216,255,106,0.25)";
    ctx.lineWidth = 2;
    ctx.strokeRect(54,54,W-108,H-108);

    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.lineWidth = 1;
    for(let y=60; y<H-60; y+=6){
      ctx.beginPath(); ctx.moveTo(54,y); ctx.lineTo(W-54,y); ctx.stroke();
    }
    ctx.restore();
  }

function drawJPBlock(ctx, text, x, y, maxWidth, lineHeight, font, color, maxLines=999){
    ctx.save();
    ctx.font = font;
    ctx.fillStyle = color;
    ctx.textBaseline = "top";

    let line = "";
    let lines = 0;
    for(const ch of text){
      if(ch === "\n"){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = "";
        continue;
      }
      const test = line + ch;
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines++;
        if(lines >= maxLines){ ctx.restore(); return; }
        line = ch;
      } else {
        line = test;
      }
    }
    if(line && lines < maxLines){
      ctx.fillText(line, x, y + lines*lineHeight);
    }
    ctx.restore();
  }

async function drawDisplaySheet(){
    const ctx = displaySheetCtx;
    const W = displaySheetCanvas.width;
    const H = displaySheetCanvas.height;

    drawSheetFrameDisplay(ctx, W, H);

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 44px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText("SHUKATSU 9000", 70, 86);

    ctx.font = "bold 28px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.75)";
    ctx.fillText("MOTHER SHUKATSU", 70, 142);

    ctx.font = "14px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.55)";
    ctx.fillText("※ 本書類はマザー・シューカーツにより生成されています。自己同一性の保証はありません。", 70, 178);
    ctx.restore();

    const photoX = W - 70 - 330;
    const photoY = 240;
    const photoW = 330;
    const photoH = 440;

    ctx.save();
    ctx.strokeStyle = "rgba(216,255,106,0.85)";
    ctx.lineWidth = 5;
    ctx.strokeRect(photoX, photoY, photoW, photoH);
    ctx.restore();

    if(session.photoDataUrl){
      const img = new Image();
      await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; img.src = session.photoDataUrl; });
      ctx.drawImage(img, photoX+4, photoY+4, photoW-8, photoH-8);
    }

    ctx.save();
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 30px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillText(SHEET_TITLE, 70, 240);

    ctx.font = "bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.85)";
    ctx.fillText("氏名", 70, 288);

    ctx.font = "bold 48px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.fillText(session.name, 70, 330);
    ctx.restore();

    const qaX=70, qaY=420, qaW=W-140, qaH=1130;
    ctx.save();
    ctx.strokeStyle="rgba(216,255,106,0.35)";
    ctx.lineWidth=2;
    ctx.strokeRect(qaX,qaY,qaW,qaH);
    ctx.font="bold 22px system-ui, -apple-system, 'Noto Sans JP'";
    ctx.fillStyle="rgba(216,255,106,0.92)";
    ctx.fillText("会話ログ（矯正強度つき）", qaX+10, qaY+10);
    ctx.restore();

    let qaText = session.qa.map((x,i)=>(
      `Q${i+1} 矯正${Math.round(x.severity*100)}% ${x.q}\n`+
      `YOU: ${x.raw}\n`+
      `MOTHER: ${x.rewritten}\n`+
      `判定: S+`
    )).join("\n\n");

    const auditChunk =
      "\n\n[監査ログ] 整合性を再計算。OK。" +
      "\n[監査ログ] 表情補正の係数を再推定。OK。" +
      "\n[監査ログ] 企業別の理想像へ再マッピング。OK。";
    while(qaText.length < 3200) qaText += auditChunk;
    qaText = qaText.slice(0, 5200);

    drawJPBlock(ctx, qaText, qaX+10, qaY+44, qaW-20, 22,
      "16px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'",
      "rgba(216,255,106,0.70)",
      44);

    ctx.save();
    ctx.fillStyle="rgba(216,255,106,0.55)";
    ctx.font="14px ui-monospace, Menlo, Monaco, Consolas, 'Noto Sans JP'";
    ctx.fillText(`MOTHER SHUKATSU // ${new Date().toLocaleString("ja-JP")}`, 70, H-60);
    ctx.restore();
  }

