<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>マザー・シューカーツ</title>
<style>
  body{
    margin:0; background:#000; color:#d8ff6a;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    min-height:100vh;
  }
  #wrap{ max-width: 560px; margin: 0 auto; padding: 16px; }
  #screen{
    border:1px solid #d8ff6a55; border-radius:16px; padding:16px;
    background: rgba(216,255,106,0.05);
  }
  .card{ display:flex; flex-direction:column; gap:12px; }
  .hidden{ display:none; }

  .title{ font-weight:900; font-size:18px; letter-spacing:.02em; }
  .box{
    border:1px solid rgba(216,255,106,0.45);
    background: rgba(216,255,106,0.08);
    border-radius:14px;
    padding:12px 12px;
    line-height:1.65;
  }
  label{ font-size:13px; opacity:.85; margin-top:6px; }
  input, textarea{
    width:100%; box-sizing:border-box;
    padding:12px; border-radius:12px;
    border:1px solid #d8ff6a33; background:#050505; color:#d8ff6a;
    font-size:16px;
  }
  textarea{ min-height:90px; resize: vertical; }

  .row{ display:flex; gap:10px; flex-wrap: wrap; }
  .btn{
    padding:12px 12px; border-radius:12px;
    border:1px solid rgba(216,255,106,0.35);
    background: rgba(216,255,106,0.12);
    color:#d8ff6a; font-size:16px; font-weight:800;
  }
  .btn.primary{ background:#d8ff6a; color:#000; border-color:#d8ff6a; }
  .btn.wide{ flex: 1 1 160px; }
  .tiny{ font-size:12px; opacity:.78; line-height:1.5; }

  #resultImg{ width:100%; border-radius:12px; border:1px solid #d8ff6a33; background:#111; }
</style>
</head>
<body>
<div id="wrap">
  <div id="screen">

    <!-- START -->
    <div id="screenStart" class="card">
      <div class="title">マザー・シューカーツ</div>
      <div class="box">
        ワタシは就活支援プログラムのマザー・シューカーツです。<br>
        一緒に理想的な自己PRシートを生成しまショウ♡
      </div>
      <button id="btnGoForm" class="btn primary">スタート</button>
    </div>

    <!-- FORM -->
    <div id="screenForm" class="card hidden">
      <div class="title">質問に回答してください</div>

      <label>お名前（任意）</label>
      <input id="name" placeholder="例：ゲスト" />

      <label>Q1：自己PRとして、あなたの強みを一言で</label>
      <textarea id="q1" placeholder="例：人を巻き込んで企画を動かす"></textarea>

      <label>Q2：あなたの弱みを一言で</label>
      <textarea id="q2" placeholder="例：忘れっぽい"></textarea>

      <label>Q3：これまでの一番の功績を一言で</label>
      <textarea id="q3" placeholder="例：文化祭の展示をまとめ上げた"></textarea>

      <div class="row">
        <button id="btnBackStart" class="btn wide">戻る</button>
        <button id="btnToCamera" class="btn primary wide">次へ</button>
      </div>
    </div>

    <!-- CAMERA / UPLOAD -->
    <div id="screenCamera" class="card hidden">
      <div class="title">写真を選んで加工シマス♡</div>

      <div class="box tiny">
        スマホのアルバムから写真を選んでください。<br>
        顔写真じゃなくてもOK♡
      </div>

      <input id="photoInput" type="file" accept="image/*" />

      <div style="position:relative; width:100%; aspect-ratio: 3/4; background:#111; border-radius:12px; overflow:hidden; border:1px solid #d8ff6a33;">
        <img id="photoPreview" alt="プレビュー" style="width:100%; height:100%; object-fit:cover;">
        <div style="position:absolute; inset:10%; border:2px dashed rgba(216,255,106,0.5); border-radius:12px; pointer-events:none;"></div>
        <div id="flash" style="position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;"></div>
      </div>

      <div class="row">
        <button id="btnCamBack" class="btn wide">戻る</button>
        <button id="btnProcessPhoto" class="btn primary wide">次へ</button>
      </div>

      <div class="tiny">※画像を選んでから「次へ」を押してください。</div>

      <canvas id="shotCanvas" width="512" height="512" class="hidden"></canvas>
    </div>

    <!-- RESULT -->
    <div id="screenResult" class="card hidden">
      <div class="title">生成完了</div>
      <img id="resultImg" alt="自己PRシート画像" />

      <div class="row">
        <button id="btnRetry" class="btn wide">やり直し</button>
        <button id="btnSave" class="btn primary wide">保存</button>
      </div>

      <div class="tiny">保存できない場合：画像を長押し→保存</div>
    </div>

  </div>
</div>

<!-- 履歴書生成用（非表示） -->
<canvas id="displaySheetCanvas" width="1240" height="1754" style="display:none;"></canvas>

<script>
// ============================================================
// 最小限のグローバル変数とセットアップ
// ============================================================
console.log("Script started");

const session = {
  name: "ゲスト",
  qa: [],
  photoDataUrl: null,
  displaySheetDataUrl: null,
};

const displaySheetCanvas = document.getElementById("displaySheetCanvas");
const displaySheetCtx = displaySheetCanvas.getContext("2d", { willReadFrequently: true });

const screens = ["screenStart","screenForm","screenCamera","screenResult"];
function show(id){
  console.log("Showing:", id);
  for(const s of screens) document.getElementById(s).classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
  window.scrollTo({top:0, behavior:"instant"});
}

console.log("Functions defined");

// ============================================================
// イベントリスナー（DOMContentLoadedで確実に設定）
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, setting up event listeners");
  
  document.getElementById("btnGoForm").addEventListener("click", function() {
    console.log("START clicked");
    show("screenForm");
  });
  
  document.getElementById("btnBackStart").addEventListener("click", function() {
    show("screenStart");
  });
  
  document.getElementById("btnToCamera").addEventListener("click", function() {
    const nameEl = document.getElementById("name");
    const q1El = document.getElementById("q1");
    const q2El = document.getElementById("q2");
    const q3El = document.getElementById("q3");
    
    session.name = (nameEl.value || "").trim() || "ゲスト";
    const a1 = (q1El.value || "").trim() || "（沈黙）";
    const a2 = (q2El.value || "").trim() || "（沈黙）";
    const a3 = (q3El.value || "").trim() || "（沈黙）";
    
    session.qa = [
      {q: "Q1", raw: a1, severity: 0},
      {q: "Q2", raw: a2, severity: 0.5},
      {q: "Q3", raw: a3, severity: 1.0}
    ];
    
    console.log("Session data:", session);
    show("screenCamera");
  });
  
  document.getElementById("btnCamBack").addEventListener("click", function() {
    show("screenForm");
  });
  
  const photoInput = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");
  let loadedImage = null;
  
  photoInput.addEventListener("change", function() {
    const file = photoInput.files && photoInput.files[0];
    if(!file) return;
    
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = function() {
      loadedImage = img;
      photoPreview.src = url;
      console.log("Image loaded");
    };
    img.onerror = function() {
      loadedImage = null;
      photoPreview.removeAttribute("src");
      URL.revokeObjectURL(url);
      alert("画像の読み込みに失敗しました");
    };
    img.src = url;
  });
  
  document.getElementById("btnProcessPhoto").addEventListener("click", async function() {
    if(!loadedImage){
      alert("先に画像を選んでください");
      return;
    }
    
    console.log("Processing photo...");
    
    // 簡易的な画像処理
    const shotCanvas = document.getElementById("shotCanvas");
    const shotCtx = shotCanvas.getContext("2d", { willReadFrequently: true });
    
    const W = shotCanvas.width, H = shotCanvas.height;
    const ar = loadedImage.width / loadedImage.height;
    const br = W / H;
    let sx=0, sy=0, sw=loadedImage.width, sh=loadedImage.height;
    if(ar > br){
      sh = loadedImage.height;
      sw = sh * br;
      sx = (loadedImage.width - sw)/2;
    }else{
      sw = loadedImage.width;
      sh = sw / br;
      sy = (loadedImage.height - sh)/2;
    }
    shotCtx.clearRect(0,0,W,H);
    shotCtx.drawImage(loadedImage, sx, sy, sw, sh, 0,0,W,H);
    
    session.photoDataUrl = shotCanvas.toDataURL("image/png");
    console.log("Photo processed");
    
    // シート生成（簡易版）
    const ctx = displaySheetCtx;
    const DW = displaySheetCanvas.width;
    const DH = displaySheetCanvas.height;
    
    // 背景
    ctx.fillStyle = "#070707";
    ctx.fillRect(0,0,DW,DH);
    
    // 枠
    ctx.strokeStyle = "rgba(216,255,106,0.75)";
    ctx.lineWidth = 6;
    ctx.strokeRect(32,32,DW-64,DH-64);
    
    // タイトル
    ctx.fillStyle = "rgba(216,255,106,0.92)";
    ctx.font = "bold 44px sans-serif";
    ctx.fillText("SHUKATSU 9000", 70, 120);
    
    // 名前
    ctx.font = "bold 36px sans-serif";
    ctx.fillText(session.name, 70, 200);
    
    // 写真
    if(session.photoDataUrl){
      const img = new Image();
      img.onload = function() {
        ctx.drawImage(img, DW-400, 100, 330, 440);
        
        // 回答
        ctx.font = "20px sans-serif";
        ctx.fillText("Q1: " + session.qa[0].raw, 70, 300);
        ctx.fillText("Q2: " + session.qa[1].raw, 70, 350);
        ctx.fillText("Q3: " + session.qa[2].raw, 70, 400);
        
        // コメント（簡易版）
        ctx.font = "18px sans-serif";
        ctx.fillText("コメント：", 70, 500);
        ctx.font = "16px sans-serif";
        ctx.fillText(session.name + "さん、素晴らしいです！", 70, 540);
        ctx.fillText("あなたの強みは明確で、", 70, 570);
        ctx.fillText("弱みも改善の余地として活かせます。", 70, 600);
        
        ctx.fillText("本当のあなた：", 70, 700);
        ctx.fillText("真面目で誠実、努力家です。", 70, 740);
        
        ctx.fillText("オススメ企業：", 70, 840);
        ctx.fillText("1. 規範維持庁／笑顔監査官", 70, 880);
        ctx.fillText("2. 適性工業／指数デザイナー", 70, 910);
        
        session.displaySheetDataUrl = displaySheetCanvas.toDataURL("image/png");
        
        document.getElementById("resultImg").src = session.displaySheetDataUrl;
        show("screenResult");
        console.log("Sheet generated");
      };
      img.src = session.photoDataUrl;
    }
  });
  
  document.getElementById("btnRetry").addEventListener("click", function() {
    show("screenStart");
  });
  
  document.getElementById("btnSave").addEventListener("click", function() {
    if(!session.displaySheetDataUrl) return;
    const a = document.createElement("a");
    a.download = "shukatsu_sheet.png";
    a.href = session.displaySheetDataUrl;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
  
  console.log("All event listeners set successfully!");
});

console.log("Script loaded completely");
</script>
</body>
</html>
